---
title: "Covid-19 Cases: Norway"
output: 
  flexdashboard::flex_dashboard:
    social: menu
    source_code: embed
    theme: flatly
    navbar:
      - { icon: "fa-sign-out-alt", href: "https://www.covid19data.no", align: left, title: "Back" }
    includes:
      in_header: ../../analytics.html
    
---


```js
$('.navbar-inverse').removeClass('navbar-inverse').addClass('navbar-default');
```


```r
library(tidyverse)
library(glue)
library(sf)
library(lubridate)
library(sparkline)
library(DT)
library(leaflet)
library(crosstalk)
library(summarywidget)

inf_raw     <- read_csv("https://raw.githubusercontent.com/thohan88/covid19-nor-data/master/data/01_infected/msis/municipality_and_district.csv")
```

```
## Parsed with column specification:
## cols(
##   date = col_date(format = ""),
##   date_time = col_datetime(format = ""),
##   kommune_bydel_no = col_character(),
##   kommune_bydel_name = col_character(),
##   bydel_no = col_character(),
##   bydel_name = col_character(),
##   kommune_no = col_character(),
##   kommune_name = col_character(),
##   fylke_no = col_character(),
##   fylke_name = col_character(),
##   population = col_double(),
##   cases = col_double()
## )
```

```r
inf_map_raw <- st_read("https://raw.githubusercontent.com/thohan88/covid19-nor-data/master/data/00_lookup_tables_and_maps/02_maps/msis.geojson", quiet = TRUE)

# MSIS-data is at bydel-level for Oslo and Bergen. Add Oslo and Bergen at municipality-level as well
inf_district <- inf_raw %>% 
  filter(bydel_name != "") %>% 
  mutate(region = paste0(bydel_name, " (", kommune_name, ")")) %>% 
  select(date, region_no = kommune_bydel_no, region, county = fylke_name, cases, population)

inf_municipality <- inf_raw %>% 
  group_by(date, region_no = kommune_no, region = kommune_name, county = fylke_name) %>% 
  summarise_at(vars(cases, population), sum, na.rm = TRUE) %>% 
  ungroup()

# Breaks for categorizing cases per population
breaks <- c(-1, 0, 0.5, 1, 2, 5, 10, 1000)
labels <- c("0", "0 - 0.5", "0.5 - 1", "1 - 2", "2 - 5", "5 - 10", ">10")

# Create sparklines for cases and growth and other statistics
inf <- inf_municipality %>% 
  bind_rows(inf_district) %>% 
  arrange(date, region) %>% 
  group_by(region_no, region) %>% 
  mutate(new_cases = cases - lag(cases, 1)) %>% 
  ungroup() %>% 
  arrange(region, date) %>% 
  group_by(region_no, region, county) %>% 
  nest() %>% 
  ungroup() %>% 
  mutate(cases_current = map(data, ~.x %>% select(cases, population) %>% slice(n())),
         cases_lag_1d  = map_dbl(data, ~.x %>%  slice(n()-1) %>% pull(cases)),
         cases_lag_5d  = map_dbl(data, ~.x %>%  slice(n()-5) %>% pull(cases)),
         cases_lag_10d = map_dbl(data, ~.x %>%  slice(n()-10) %>% pull(cases))) %>% 
  unnest(cases_current) %>% 
  mutate(cases_inc_1d        = cases - cases_lag_1d,
         cases_per_pop       = round(cases/population*1000, 1),
         cases_log           = log10(cases),
         cases_per_pop_grp   = cut(cases_per_pop, include.lowest = TRUE, breaks = breaks, labels = labels),
         doubling_time_1d    = round((1*log(2))/log(cases/cases_lag_1d), 1),
         doubling_time_5d    = round((5*log(2))/log(cases/cases_lag_5d), 1),
         doubling_time_10d   = round((10*log(2))/log(cases/cases_lag_10d), 1),
         sparkline_cases     = map(data, ~.x %>% slice((n()-10):n()) %>% pull(cases) %>% spk_chr(type="line")),
         sparkline_new_cases = map(data, ~.x %>% slice((n()-10):n()) %>% pull(new_cases) %>% spk_chr(type="bar"))) %>% 
  mutate_at(vars(matches("doubling|log"), cases_per_pop), ~ifelse(is.na(.x) | is.infinite(.x) | is.nan(.x) | .x <= 0, NA, .x)) %>% 
  select(-data)

# Setup a map and add pop-info 
inf_map <- inf_map_raw %>%
  select(region_no = kommune_bydel_no) %>%
  left_join(inf, by = "region_no") %>% 
  mutate(cases_per_pop_grp = cut(cases_per_pop, include.lowest = TRUE, breaks = breaks, labels = labels)) %>% 
  mutate(cases_per_pop_grp = cut(cases_per_pop, include.lowest = TRUE, breaks = breaks, labels = labels)) %>% 
  mutate(popup_table = map2(cases, cases_per_pop, ~glue('<table><tr><td><b>Cases: </b></td><td align = "right">{coalesce(.x, 0)}</td></tr><tr><td><b>Cases per population: </b></td><td align = "right">{coalesce(.y, 0)}</td></tr></table>'))) %>%
  mutate(popup_table = map2(region, popup_table,  ~glue("<h3>{.x}</h3>{.y}"))) %>%
  select(region, popup_table, cases, cases_log, cases_per_pop, cases_per_pop_grp)
```

```
## Warning: Column `region_no` joining factor and character vector, coercing into character vector
```

```r
# Setup tables
inf_tbl <- inf %>%
  select(region, cases, cases_inc_1d, cases_per_pop, sparkline_cases, sparkline_new_cases,
         doubling_time_5d, doubling_time_10d, population, county, region_no) %>% 
  arrange(desc(cases)) %>% 
  mutate_at(vars(matches("doubling")), ~as.character(.x) %>% coalesce("")) %>% 
  mutate(cases_per_pop = coalesce(cases_per_pop, 0),
         cases_summary = ifelse(str_detect(region_no, "^[0-9]{4}$"), cases, 0) %>% coalesce(0),
         cases_new_summary = ifelse(str_detect(region_no, "^[0-9]{4}$"), cases_inc_1d, 0) %>% coalesce(0))

inf_sd <- SharedData$new(inf_tbl)
```


Dashboard {data-icon="fa-dashboard"}
===================================== 

Inputs {.sidebar}
-------------------------------------


<p class="text-muted", align = "center">Updated: 07. April 20 06:00</p>



```r
filter_select("county_select", "County", inf_sd, ~county, multiple = FALSE)
```

<!--html_preserve--><div id="county_select" class="form-group crosstalk-input-select crosstalk-input">
<label class="control-label" for="county_select">County</label>
<div>
<select></select>
<script type="application/json" data-for="county_select">{
  "items": {
    "value": ["Agder", "Innlandet", "Møre og Romsdal", "Nordland", "Oslo", "Rogaland", "Svalbard", "Troms og Finnmark", "Trøndelag", "Ukjent Fylke", "Vestfold og Telemark", "Vestland", "Viken"],
    "label": ["Agder", "Innlandet", "Møre og Romsdal", "Nordland", "Oslo", "Rogaland", "Svalbard", "Troms og Finnmark", "Trøndelag", "Ukjent Fylke", "Vestfold og Telemark", "Vestland", "Viken"]
  },
  "map": {
    "Agder": ["6", "66", "101", "115", "127", "139", "164", "177", "178", "197", "199", "200", "201", "231", "244", "245", "250", "257", "264", "281", "300", "348", "372", "379", "381"],
    "Innlandet": ["26", "32", "50", "55", "56", "87", "92", "94", "100", "102", "110", "113", "118", "124", "144", "145", "147", "155", "167", "175", "179", "184", "198", "208", "217", "222", "225", "227", "230", "237", "254", "261", "266", "268", "275", "301", "340", "342", "345", "346", "359", "363", "370", "374", "380", "383"],
    "Møre og Romsdal": ["63", "74", "89", "109", "131", "134", "138", "146", "171", "174", "176", "181", "202", "205", "223", "224", "239", "271", "277", "283", "286", "306", "357", "365", "368", "382"],
    "Nordland": ["57", "143", "148", "151", "158", "165", "183", "189", "192", "193", "194", "195", "212", "221", "238", "241", "243", "269", "279", "280", "288", "290", "292", "296", "305", "309", "311", "312", "313", "327", "330", "335", "338", "341", "349", "351", "353", "360", "371", "378", "384"],
    "Oslo": ["1", "5", "7", "10", "11", "12", "14", "15", "18", "19", "20", "21", "23", "25", "29", "30", "60", "172", "210"],
    "Rogaland": ["13", "34", "37", "51", "73", "86", "93", "95", "97", "99", "103", "105", "132", "133", "186", "187", "235", "291", "315", "322", "329", "366", "377"],
    "Svalbard": ["367"],
    "Troms og Finnmark": ["17", "82", "88", "140", "161", "170", "173", "182", "191", "209", "211", "214", "215", "219", "233", "234", "251", "252", "253", "256", "260", "267", "270", "273", "278", "287", "289", "294", "304", "307", "310", "317", "318", "320", "324", "328", "331", "361", "364"],
    "Trøndelag": ["4", "59", "75", "84", "96", "98", "108", "117", "122", "126", "128", "130", "136", "150", "152", "153", "168", "180", "185", "203", "207", "229", "246", "247", "249", "259", "299", "302", "325", "326", "336", "337", "343", "347", "350", "352", "358", "373"],
    "Ukjent Fylke": ["274"],
    "Vestfold og Telemark": ["35", "47", "52", "68", "69", "70", "77", "123", "142", "166", "213", "220", "228", "236", "255", "272", "303", "314", "321", "333", "339", "355", "369"],
    "Vestland": ["2", "31", "33", "38", "42", "44", "45", "48", "49", "53", "61", "65", "76", "78", "85", "104", "111", "114", "121", "125", "129", "137", "156", "157", "159", "160", "162", "163", "188", "190", "226", "232", "248", "276", "282", "284", "285", "293", "295", "297", "298", "308", "316", "323", "332", "334", "344", "354", "362", "375", "376", "385"],
    "Viken": ["3", "8", "9", "16", "22", "24", "27", "28", "36", "39", "40", "41", "43", "46", "54", "58", "62", "64", "67", "71", "72", "79", "80", "81", "83", "90", "91", "106", "107", "112", "116", "119", "120", "135", "141", "149", "154", "169", "196", "204", "206", "216", "218", "240", "242", "258", "262", "263", "265", "319", "356"]
  },
  "group": ["SharedData09db913a"]
}</script>
</div>
</div><!--/html_preserve-->


```r
filter_slider("pop_slider", "Population", inf_sd, ~population, min = 0, max = 750E3)
```

<!--html_preserve--><div class="form-group crosstalk-input crosstalk-input-slider js-range-slider" id="pop_slider">
<label class="control-label" for="pop_slider">Population</label>
<input data-type="double" data-min="0" data-max="750000" data-from="0" data-to="693494" data-step="1" data-grid="true" data-grid-num="10" data-grid-snap="false" data-prettify-separator="," data-keyboard="true" data-keyboard-step="0.000133333333333333" data-drag-interval="true" data-data-type="number"/>
<script type="application/json" data-for="pop_slider">{
  "values": [0, 0, 198, 388, 435, 461, 462, 498, 517, 548, 557, 569, 728, 769, 802, 843, 852, 888, 906, 926, 932, 948, 957, 965, 1005, 1015, 1017, 1034, 1050, 1080, 1083, 1091, 1103, 1132, 1162, 1164, 1191, 1200, 1213, 1225, 1231, 1268, 1272, 1279, 1287, 1290, 1297, 1325, 1328, 1331, 1348, 1355, 1361, 1371, 1390, 1426, 1448, 1471, 1482, 1545, 1562, 1573, 1578, 1610, 1680, 1691, 1761, 1777, 1780, 1781, 1822, 1829, 1836, 1890, 1891, 1926, 1950, 1975, 1975, 1981, 2003, 2029, 2034, 2063, 2071, 2097, 2125, 2126, 2146, 2150, 2197, 2200, 2201, 2212, 2221, 2228, 2294, 2297, 2340, 2359, 2386, 2403, 2419, 2422, 2428, 2432, 2439, 2461, 2485, 2486, 2486, 2549, 2553, 2569, 2574, 2608, 2627, 2628, 2629, 2635, 2688, 2766, 2787, 2794, 2802, 2839, 2854, 2869, 2870, 2888, 2910, 2918, 2927, 2954, 3011, 3025, 3117, 3119, 3162, 3189, 3202, 3229, 3273, 3280, 3464, 3467, 3507, 3509, 3570, 3595, 3629, 3634, 3662, 3676, 3804, 3805, 3884, 3977, 3998, 4005, 4060, 4062, 4062, 4101, 4216, 4288, 4356, 4392, 4410, 4441, 4454, 4523, 4595, 4608, 4612, 4663, 4668, 4671, 4674, 4861, 5016, 5050, 5100, 5151, 5174, 5175, 5193, 5226, 5236, 5559, 5578, 5581, 5617, 5691, 5723, 5736, 5739, 5766, 5788, 5788, 5854, 5920, 5951, 5963, 5987, 6053, 6106, 6106, 6238, 6288, 6413, 6515, 6532, 6627, 6633, 6640, 6799, 6809, 6816, 6852, 6890, 7001, 7036, 7130, 7203, 7447, 7468, 7508, 7625, 7674, 7905, 7917, 8061, 8098, 8255, 8325, 8457, 8462, 8571, 8714, 8900, 9028, 9048, 9310, 9457, 9608, 9623, 9691, 9739, 10084, 10158, 10323, 10365, 10380, 10444, 10473, 10566, 10825, 11048, 11065, 11074, 11110, 11221, 11433, 11448, 11847, 11957, 12002, 12968, 13049, 13071, 13278, 13279, 13427, 13630, 13820, 14061, 14115, 14139, 14148, 14774, 14811, 14851, 14948, 14973, 15230, 15740, 15877, 16733, 17207, 17390, 17829, 18042, 18217, 18530, 18759, 18916, 18991, 19423, 19588, 19616, 20164, 20439, 20789, 21064, 21254, 21845, 22030, 23046, 23092, 23544, 24145, 24179, 24249, 24357, 24699, 24703, 24908, 25436, 26184, 26730, 26811, 27153, 27351, 27707, 27723, 28345, 29224, 29279, 29553, 30071, 30560, 30641, 31369, 31373, 31967, 33316, 33422, 34569, 34768, 36397, 37357, 38316, 38945, 39066, 39625, 40409, 41460, 41629, 42186, 42223, 42790, 43139, 44792, 44999, 45089, 47204, 49273, 49801, 50157, 50806, 52327, 52357, 52459, 54942, 56293, 56732, 58671, 59269, 59288, 62423, 63764, 66258, 76974, 79537, 82385, 85983, 94441, 101386, 111633, 127731, 143574, 205163, 283929, 693494],
  "keys": ["274", "367", "377", "334", "371", "352", "384", "351", "322", "297", "325", "48", "378", "373", "188", "337", "235", "328", "295", "260", "281", "343", "289", "178", "310", "335", "288", "182", "240", "226", "294", "307", "299", "304", "197", "379", "320", "193", "349", "211", "249", "198", "241", "237", "303", "324", "311", "196", "316", "250", "296", "326", "317", "143", "263", "290", "339", "172", "243", "301", "370", "314", "380", "210", "245", "332", "338", "313", "346", "284", "264", "364", "231", "330", "342", "360", "305", "208", "221", "247", "347", "278", "327", "358", "318", "381", "383", "323", "219", "357", "266", "252", "369", "319", "287", "184", "183", "308", "220", "180", "60", "321", "363", "259", "201", "230", "216", "171", "354", "120", "152", "239", "144", "292", "315", "269", "59", "251", "306", "385", "242", "309", "291", "209", "298", "256", "204", "375", "285", "355", "253", "270", "267", "359", "282", "271", "277", "268", "214", "125", "329", "345", "83", "187", "361", "356", "176", "283", "275", "258", "293", "199", "227", "228", "366", "265", "168", "276", "170", "234", "236", "136", "159", "248", "273", "229", "155", "124", "341", "43", "312", "365", "186", "112", "147", "280", "206", "353", "90", "215", "340", "203", "217", "302", "163", "202", "232", "177", "156", "233", "374", "350", "222", "272", "92", "154", "50", "190", "191", "286", "160", "224", "200", "246", "257", "372", "145", "179", "128", "165", "118", "213", "382", "225", "261", "331", "106", "348", "126", "149", "119", "122", "223", "104", "175", "195", "109", "218", "368", "102", "94", "158", "148", "344", "262", "153", "114", "146", "131", "105", "181", "300", "116", "138", "362", "192", "336", "101", "238", "207", "173", "108", "164", "255", "333", "174", "189", "134", "376", "73", "127", "54", "103", "194", "88", "129", "157", "97", "95", "166", "162", "279", "205", "110", "113", "111", "142", "107", "81", "117", "139", "86", "82", "96", "167", "150", "65", "80", "185", "121", "141", "254", "67", "98", "72", "137", "99", "132", "169", "133", "40", "75", "79", "140", "55", "100", "212", "78", "115", "91", "244", "130", "74", "41", "84", "77", "161", "85", "58", "151", "68", "62", "93", "69", "25", "71", "56", "76", "53", "61", "38", "87", "135", "26", "64", "89", "18", "30", "23", "32", "123", "34", "45", "29", "21", "36", "44", "27", "49", "51", "33", "31", "42", "39", "66", "20", "70", "24", "7", "14", "11", "19", "57", "15", "47", "35", "46", "5", "10", "22", "12", "52", "63", "17", "37", "28", "16", "9", "8", "6", "3", "13", "4", "2", "1"],
  "group": ["SharedData09db913a"]
}</script>
</div><!--/html_preserve-->


```r
filter_slider("case_slider", "Cases", inf_sd, ~cases)
```

<!--html_preserve--><div class="form-group crosstalk-input crosstalk-input-slider js-range-slider" id="case_slider">
<label class="control-label" for="case_slider">Cases</label>
<input data-type="double" data-min="0" data-max="1673" data-from="0" data-to="1673" data-step="1" data-grid="true" data-grid-num="9.95833333333333" data-grid-snap="false" data-prettify-separator="," data-keyboard="true" data-keyboard-step="0.0597728631201434" data-drag-interval="true" data-data-type="number"/>
<script type="application/json" data-for="case_slider">{
  "values": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 11, 12, 12, 12, 13, 13, 13, 13, 13, 13, 13, 14, 14, 14, 14, 14, 15, 15, 16, 16, 16, 16, 17, 17, 17, 18, 18, 19, 19, 19, 20, 21, 21, 22, 23, 24, 24, 24, 25, 27, 28, 28, 28, 28, 30, 31, 31, 32, 35, 35, 36, 36, 37, 37, 40, 40, 43, 43, 43, 44, 44, 44, 44, 45, 48, 49, 49, 55, 56, 57, 66, 67, 69, 71, 71, 73, 78, 84, 88, 93, 102, 102, 109, 110, 120, 121, 122, 125, 125, 130, 136, 138, 140, 140, 156, 169, 200, 327, 356, 1673],
  "keys": ["280", "281", "282", "283", "284", "285", "286", "287", "288", "289", "290", "291", "292", "293", "294", "295", "296", "297", "298", "299", "300", "301", "302", "303", "304", "305", "306", "307", "308", "309", "310", "311", "312", "313", "314", "315", "316", "317", "318", "319", "320", "321", "322", "323", "324", "325", "326", "327", "328", "329", "330", "331", "332", "333", "334", "335", "336", "337", "338", "339", "340", "341", "342", "343", "344", "345", "346", "347", "348", "349", "350", "351", "352", "353", "354", "355", "356", "357", "358", "359", "360", "361", "362", "363", "364", "365", "366", "367", "368", "369", "370", "371", "372", "373", "374", "375", "376", "377", "378", "379", "380", "381", "382", "383", "384", "385", "229", "230", "231", "232", "233", "234", "235", "236", "237", "238", "239", "240", "241", "242", "243", "244", "245", "246", "247", "248", "249", "250", "251", "252", "253", "254", "255", "256", "257", "258", "259", "260", "261", "262", "263", "264", "265", "266", "267", "268", "269", "270", "271", "272", "273", "274", "275", "276", "277", "278", "279", "195", "196", "197", "198", "199", "200", "201", "202", "203", "204", "205", "206", "207", "208", "209", "210", "211", "212", "213", "214", "215", "216", "217", "218", "219", "220", "221", "222", "223", "224", "225", "226", "227", "228", "175", "176", "177", "178", "179", "180", "181", "182", "183", "184", "185", "186", "187", "188", "189", "190", "191", "192", "193", "194", "155", "156", "157", "158", "159", "160", "161", "162", "163", "164", "165", "166", "167", "168", "169", "170", "171", "172", "173", "174", "140", "141", "142", "143", "144", "145", "146", "147", "148", "149", "150", "151", "152", "153", "154", "132", "133", "134", "135", "136", "137", "138", "139", "125", "126", "127", "128", "129", "130", "131", "119", "120", "121", "122", "123", "124", "111", "112", "113", "114", "115", "116", "117", "118", "106", "107", "108", "109", "110", "100", "101", "102", "103", "104", "105", "97", "98", "99", "90", "91", "92", "93", "94", "95", "96", "85", "86", "87", "88", "89", "83", "84", "79", "80", "81", "82", "76", "77", "78", "74", "75", "71", "72", "73", "70", "68", "69", "67", "66", "63", "64", "65", "62", "61", "57", "58", "59", "60", "56", "54", "55", "53", "51", "52", "49", "50", "47", "48", "45", "46", "42", "43", "44", "38", "39", "40", "41", "37", "36", "34", "35", "33", "32", "31", "30", "29", "28", "26", "27", "25", "24", "23", "22", "21", "19", "20", "18", "17", "16", "15", "14", "12", "13", "11", "10", "9", "7", "8", "6", "5", "4", "3", "2", "1"],
  "group": ["SharedData09db913a"]
}</script>
</div><!--/html_preserve-->




